# AMStreamer Build Notes / AMStreamer 构建说明

## Overview / 概述

**English:**  
AMStreamer targets the OpenIPC ecosystem as an Amlogic-based ground receiver. We picked consumer Amlogic TV boxes such as S905L3A/S905X2 because they are inexpensive, abundant in the Chinese market, and provide surprisingly strong hardware decoding. The implementation borrows ideas from CoreELEC, moonlight-embedded, and [github.com/openipc/pixelpilot_rk](https://github.com/openipc/pixelpilot_rk). This document keeps both English and Chinese descriptions side by side.

AMStreamer uses GStreamer + libamcodec for video and optionally pipes RTP audio (payload type 98 / Opus) straight into ALSA sinks, so you can build everything directly under `build.CoreELEC-Amlogic-ng.arm-21`.

**中文：**  
AMStreamer 的目标是为 **OpenIPC** 提供一款面向 Amlogic 平台的地面端接收程序。之所以选择 Amlogic 盒子（例如 S905L3A / S905X2），是因为在中国市场它们价格低廉、供应充足、硬件解码性能又非常强劲，非常适合作为地面端接收设备。实现过程中参考了 CoreELEC、moonlight-embedded 以及 [github.com/openipc/pixelpilot_rk](https://github.com/openipc/pixelpilot_rk) 等项目。本 README 中英双语并行，便于查阅。

AMStreamer 使用 GStreamer + libamcodec 处理视频流，并提供可选的 RTP 音频（默认 payload type 98 / Opus）直接输出到 ALSA sink，方便在 CoreELEC 的 `build.CoreELEC-Amlogic-ng.arm-21` 目录下单独交叉编译。

## Prerequisites / 前置条件

**EN:**  
- CoreELEC toolchain (`armv8a-libreelec-linux-gnueabihf-`) generated by the CoreELEC build system.  
- Sysroot located at `toolchain/armv8a-libreelec-linux-gnueabihf/sysroot` (adjust `SYSROOT` in the Makefile if yours differs).  
- GStreamer, glib, fmt, spdlog, libamcodec and friends already installed inside the sysroot.

**CN：**  
- 已经按 CoreELEC 构建系统生成的交叉编译工具链 (`armv8a-libreelec-linux-gnueabihf-`)。  
- Sysroot 默认在 `toolchain/armv8a-libreelec-linux-gnueabihf/sysroot`，若不同需修改 `Makefile` 的 `SYSROOT`。  
- Sysroot 中需包含 GStreamer、glib、fmt、spdlog、libamcodec 等依赖。

## Build Steps / 构建步骤

**EN:**  
```bash
cd /home/imgae/projects/CoreELEC/build.CoreELEC-Amlogic-ng.arm-21/build/AMStreamer
make            # builds AMLDigitalFPV
make clean      # removes build/ and the binary
```

**CN：**  
```bash
cd /home/imgae/projects/CoreELEC/build.CoreELEC-Amlogic-ng.arm-21/build/AMStreamer
make            # 生成 AMLDigitalFPV
make clean      # 清理 build/ 目录和生成的二进制
```

如需调整源文件或编译选项，请编辑根目录 `Makefile`。构建产物位于 `build/`，最终可执行文件 `AMLDigitalFPV` 位于当前目录。

## Source Layout / 源码结构

- `src/`: source files (`main.cpp`, `gstrtpreceiver.cpp`, `aml.c`, `util.c`, …) / 实际源文件。  
- `Makefile`: top-level build entry that places outputs in `build/` / 根目录构建脚本。  
- `.gitignore`: ignores intermediates, binaries, editor caches / 忽略中间文件与临时文件。

## Audio RTP Support / 音频 RTP 支持

**EN:**  
Call `enable_audio_stream(port, 98, "default")` (before `start_receiving()`) to enable RTP audio. The current pipeline assumes Opus payloads, feeds `alsasink`, and intentionally skips A/V sync to minimize latency.

**CN：**  
若启用音频 RTP（payload type 默认 98，假设 Opus），请在 `start_receiving()` 前调用 `enable_audio_stream(port, 98, "default")`。音频链路使用 `alsasink`，默认不做音画同步以降低延迟，可按需修改设备名或同步策略。

## Notes / 补充说明

**EN:**  
- Extend the `install` target in the Makefile if you need to deploy the binary somewhere else.  
- Update toolchain/sysroot paths in the Makefile whenever your CoreELEC tree moves.  
- Missing libs? rebuild or install them in the CoreELEC sysroot.

**CN：**  
- 如需安装到目标系统，可扩展 `Makefile` 的 `install` 目标。  
- 工具链或 sysroot 路径变动时，别忘了同步更新 `Makefile`。  
- 若构建缺库，请在 CoreELEC 环境中重新安装/配置依赖。

感谢 CoreELEC、moonlight-embedded 与 pixelpilot_rk 等项目提供的实现思路，欢迎继续在 OpenIPC / Amlogic 场景下拓展 AMStreamer。Happy hacking!
